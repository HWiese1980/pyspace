<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pySPACE.missions.operations.node_chain &#8212; pySPACE documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/pySPACE.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.3 release',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/pyspace-logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pySPACE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/pyspace-logo_small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pySPACE.missions.operations.node_chain</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Interface to :mod:`~pySPACE.environments.chains.node_chain` using the :class:`~pySPACE.environments.chains.node_chain.BenchmarkNodeChain`</span>

<span class="sd">.. image:: ../../graphics/node_chain.png</span>
<span class="sd">   :width: 500</span>

<span class="sd">A process consists of applying</span>
<span class="sd">the given `node_chain` on an input for a certain parameters setting.</span>

<span class="sd">Factory methods are provided that create this operation based</span>
<span class="sd">on  a specification in one or more YAML files.</span>

<span class="sd">.. note:: Complete lists of available nodes and namings can be found</span>
<span class="sd">          at: :ref:`node_list`.</span>

<span class="sd">.. seealso::</span>

<span class="sd">    - :mod:`~pySPACE.missions.nodes`</span>
<span class="sd">    - :ref:`node_list`</span>
<span class="sd">    - :mod:`~pySPACE.environments.chains.node_chain`</span>

<span class="sd">Specification file Parameters</span>
<span class="sd">+++++++++++++++++++++++++++++</span>

<span class="sd">type</span>
<span class="sd">----</span>

<span class="sd">Specifies which operation is used. For this operation</span>
<span class="sd">you have to use *node_chain*.</span>

<span class="sd">(*obligatory, node_chain*)</span>

<span class="sd">input_path</span>
<span class="sd">----------</span>

<span class="sd">Path name relative to the *storage* in your configuration file.</span>

<span class="sd">The input has to fulfill certain rules,</span>
<span class="sd">specified in the fitting: :mod:`~pySPACE.resources.dataset_defs` subpackage.</span>
<span class="sd">For each dataset in the input and each parameter combination</span>
<span class="sd">you get an own result.</span>

<span class="sd">(*obligatory*)</span>

<span class="sd">templates</span>
<span class="sd">---------</span>

<span class="sd">List of node chain file templates which shall be evaluated.</span>
<span class="sd">The final node chain is constructed, by substituting specified parameters</span>
<span class="sd">of the operation spec file. Therefore you should use the format</span>
<span class="sd">*__PARAMETER__*. Already fixed and usable keywords are</span>
<span class="sd">*__INPUT_DATASET__* and *__RESULT_DIRECTORY__*.</span>
<span class="sd">The spec file name may include a path and it is searched relative</span>
<span class="sd">the folder *node_chains* in the specs folder,</span>
<span class="sd">given in your configuration file you used, when starting :ref:`pySPACE`</span>
<span class="sd">(:mod:`pySPACE.run.launch`).</span>

<span class="sd">If no template is given, the software tries to use the</span>
<span class="sd">parameters *node_chain*, which simply includes the *node_chain* description.</span>

<span class="sd">.. todo:: Check that parameter fulfills format rule!</span>

<span class="sd">(*recommended, alternative: `node_chain`*)</span>

<span class="sd">node_chain</span>
<span class="sd">----------</span>

<span class="sd">Instead of using a template you can use your single node chain directly</span>
<span class="sd">in the operation spec.</span>

<span class="sd">(*optional, default: `templates`*)</span>

<span class="sd">runs</span>
<span class="sd">----</span>

<span class="sd">Number of repetitions for each running process.</span>
<span class="sd">The run number is given to the process, to use it for *choosing*</span>
<span class="sd">random components, especially when using cross-validation.</span>

<span class="sd">(*optional, default: 1*)</span>

<span class="sd">parameter_ranges</span>
<span class="sd">----------------</span>

<span class="sd">Dictionary with parameter names as keys and a list of values it</span>
<span class="sd">should be replaced with.</span>
<span class="sd">Finally a grid of all possible combinations is build and afterwards</span>
<span class="sd">only those remain fulfilling the constraints.</span>

<span class="sd">(*mandatory if parameter_setting is not used*)</span>

<span class="sd">parameter_setting</span>
<span class="sd">-----------------</span>

<span class="sd">If you do not use the *parameter_ranges*, this is a list of</span>
<span class="sd">dictionaries giving the parameter combinations, you want to test</span>
<span class="sd">the operation on.</span>

<span class="sd">(*mandatory if parameter_ranges is not used*)</span>

<span class="sd">constraints</span>
<span class="sd">-----------</span>

<span class="sd">List of strings, where the place holders for the parameter values are replaced</span>
<span class="sd">as in the node chain template.</span>
<span class="sd">After creating all possible combinations of parameters, they are inserted</span>
<span class="sd">into this string and the string is evaluated like a Python expression.</span>
<span class="sd">If it is not evaluated to *True*, the parameter is rejected.</span>
<span class="sd">The test is performed for each constraint (string). For being used later on,</span>
<span class="sd">a parameter setting has to pass all tests. Example:</span>

<span class="sd">.. code-block:: yaml</span>

<span class="sd">    __alg__ in [&#39;A&#39;,&#39;B&#39;,&#39;C&#39;] and __par__ == 0.1 or __alg__ == &#39;D&#39;</span>

<span class="sd">(*optional, default: []*)</span>

<span class="sd">old_parameter_constraints</span>
<span class="sd">-------------------------</span>
<span class="sd">Same as *constraints*, but here parameters of earlier</span>
<span class="sd">operation calls, e.g. windowing, can be used in the constraint def.</span>

<span class="sd">hide_parameters</span>
<span class="sd">---------------</span>

<span class="sd">Normally each parameter is added in the format</span>
<span class="sd">*{__PARAMETER__: value}* added to the *__RESULT_DIRECTORY__*.</span>
<span class="sd">Every parameter specified in the list *hide_parameters* is not</span>
<span class="sd">added to the folder name. Be careful not to have</span>
<span class="sd">the same name for different results.</span>

<span class="sd">(*optional, default: []*)</span>

<span class="sd">storage_format</span>
<span class="sd">--------------</span>

<span class="sd">Some datasets give the opportunity to choose between different</span>
<span class="sd">formats for storing the result. The choice can be specified here.</span>
<span class="sd">For details look at the :mod:`~pySPACE.resources.dataset_defs` documentation.</span>
<span class="sd">If the format is not specified, the default of the</span>
<span class="sd">dataset is used.</span>

<span class="sd">(*optional, default: default of dataset*)</span>

<span class="sd">store_node_chain</span>
<span class="sd">----------------</span>

<span class="sd">If True, the total state of the node chain after the processing is stored to disk.</span>
<span class="sd">This is done separately for each split and run.</span>
<span class="sd">If *store_node_chain* is a tuple of length 2---lets say (i1,i2)---only the</span>
<span class="sd">subflow starting at the i1-th node and ending at the (i2-1)-th node is stored.</span>
<span class="sd">This may be useful when the stored flow should be used in an ensemble.</span>
<span class="sd">If *store_node_chain* is a list with indices, all nodes in the chain with the</span>
<span class="sd">corresponding indices are stored. This might be useful to exclude specific nodes</span>
<span class="sd">that do not change the data dimension / type, like e.g. visualization nodes.</span>

<span class="sd">.. note:: Since yaml cannot recognize tuples, string parameters are evaluated</span>
<span class="sd">          before type testing (if boolean, tuple, list) is done.</span>

<span class="sd">(*optional, default: False*)</span>

<span class="sd">compression</span>
<span class="sd">-----------</span>

<span class="sd">If your result is a classification summary,</span>
<span class="sd">all the created sub-folders are zipped with the zipfile module,</span>
<span class="sd">since they are normally not needed anymore,</span>
<span class="sd">but you may have numerous folders, making coping difficult.</span>
<span class="sd">To switch this of, use the value *False* and if you want no</span>
<span class="sd">compression, use *1*. If all the sub-folders (except a single one)</span>
<span class="sd">should be deleted, set compression to ``delete``.</span>

<span class="sd">(*optional, default: 8*)</span>


<span class="sd">Exemplary Call</span>
<span class="sd">++++++++++++++</span>

<span class="sd">.. code-block:: yaml</span>

<span class="sd">    type: node_chain</span>
<span class="sd">    input_path: &quot;my_data&quot;</span>
<span class="sd">    runs : 2</span>
<span class="sd">    templates : [&quot;example_node_chain1.yaml&quot;,&quot;example_node_chain2.yaml&quot;,&quot;example_node_chain3.yaml&quot;]</span>

<span class="sd">.. code-block:: yaml</span>

<span class="sd">    type: node_chain</span>
<span class="sd">    input_path: &quot;my_data&quot;</span>
<span class="sd">    runs : 2</span>
<span class="sd">    parameter_ranges :</span>
<span class="sd">        __prob__ : eval(range(1,4))</span>
<span class="sd">    node_chain :</span>
<span class="sd">        -</span>
<span class="sd">            node: FeatureVectorSource</span>
<span class="sd">        -</span>
<span class="sd">            node: CrossValidationSplitter</span>
<span class="sd">            parameters:</span>
<span class="sd">                splits : 5</span>
<span class="sd">        -</span>
<span class="sd">            node: GaussianFeatureNormalization</span>
<span class="sd">        -</span>
<span class="sd">            node: LinearDiscriminantAnalysisClassifier</span>
<span class="sd">            parameters:</span>
<span class="sd">                class_labels: [&quot;Standard&quot;,&quot;Target&quot;]</span>
<span class="sd">                prior_probability : [1,__prob__]</span>
<span class="sd">        -</span>
<span class="sd">            node: ThresholdOptimization</span>
<span class="sd">            parameters:</span>
<span class="sd">                metric : Balanced_accuracy</span>

<span class="sd">        -</span>
<span class="sd">            node: Classification_Performance_Sink</span>
<span class="sd">            parameters:</span>
<span class="sd">                ir_class: &quot;Target&quot;</span>

<span class="sd">.. code-block:: yaml</span>

<span class="sd">    type: node_chain</span>

<span class="sd">    input_path: &quot;example_data&quot;</span>
<span class="sd">    templates : [&quot;example_flow.yaml&quot;]</span>
<span class="sd">    backend: &quot;local&quot;</span>
<span class="sd">    parameter_ranges :</span>
<span class="sd">        __LOWER_CUTOFF__ : [0.1, 1.0, 2.0]</span>
<span class="sd">        __UPPER_CUTOFF__ : [2.0, 4.0]</span>
<span class="sd">    constraints:</span>
<span class="sd">        - &quot;__LOWER_CUTOFF__ &lt; __UPPER_CUTOFF__&quot;</span>


<span class="sd">    runs : 10</span>

<span class="sd">.. code-block:: yaml</span>

<span class="sd">    type: node_chain</span>
<span class="sd">    input_path: &quot;my_data&quot;</span>
<span class="sd">    runs : 2</span>
<span class="sd">    templates : [&quot;example_node_chain.yaml&quot;]</span>
<span class="sd">    parameter_setting :</span>
<span class="sd">        -</span>
<span class="sd">            __prob__ : 1</span>
<span class="sd">        -</span>
<span class="sd">            __prob__ : 2</span>
<span class="sd">        -</span>
<span class="sd">            __prob__ : 3</span>

<span class="sd">Here `example_node_chain.yaml` is defined in the node chain specification folder as</span>

<span class="sd">.. literalinclude:: ../../examples/specs/node_chains/example_node_chain.yaml</span>
<span class="sd">    :language: yaml</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># processing was renamed in Python 2.6 to multiprocessing</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">processing</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">processing</span>

<span class="c1"># import of all necessary pySPACE packages</span>
<span class="kn">import</span> <span class="nn">pySPACE</span>
<span class="kn">from</span> <span class="nn">pySPACE.missions.operations.base</span> <span class="k">import</span> <span class="n">Operation</span><span class="p">,</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">pySPACE.resources.dataset_defs.base</span> <span class="k">import</span> <span class="n">BaseDataset</span>
<span class="kn">from</span> <span class="nn">pySPACE.tools.filesystem</span> <span class="k">import</span> <span class="n">create_directory</span>
<span class="kn">from</span> <span class="nn">pySPACE.tools.conversion</span> <span class="k">import</span> <span class="n">replace_parameters2</span>
<span class="kn">from</span> <span class="nn">pySPACE.environments.chains.node_chain</span> \
    <span class="kn">import</span> <span class="nn">BenchmarkNodeChain</span><span class="o">,</span> <span class="nn">NodeChainFactory</span>

<span class="kn">from</span> <span class="nn">pySPACE.resources.dataset_defs.performance_result</span> \
    <span class="kn">import</span> <span class="nn">PerformanceResultSummary</span>
<span class="kn">from</span> <span class="nn">pySPACE.tools.filesystem</span> <span class="k">import</span> <span class="n">get_author</span>


<div class="viewcode-block" id="NodeChainOperation"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation">[docs]</a><span class="k">class</span> <span class="nc">NodeChainOperation</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load configuration file, create processes and consolidate results</span>

<span class="sd">    The operation consists of a set of processes. Each of</span>
<span class="sd">    these processes consists of applying a given</span>
<span class="sd">    :class:`~pySPACE.environments.chains.node_chain.BenchmarkNodeChain` on</span>
<span class="sd">    an input  for a certain configuration of parameters.</span>

<span class="sd">    The results of this operation are collected using the</span>
<span class="sd">    consolidate method that produces a consistent representation</span>
<span class="sd">    of the result. Especially it collects not only the data,</span>
<span class="sd">    but also saves information of the in and out coming files and the used</span>
<span class="sd">    specification files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="NodeChainOperation.__init__"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span>
                 <span class="n">number_processes</span><span class="p">,</span> <span class="n">create_process</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># temporary replacement of template keyword for better layout when</span>
        <span class="c1"># source_operation.yaml file is saved to result folder</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">basestring</span><span class="p">:</span>
            <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templates</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NodeChainOperation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span>
                                                 <span class="n">result_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_spec</span> <span class="o">=</span> <span class="n">templates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_process</span> <span class="o">=</span> <span class="n">create_process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_processes</span> <span class="o">=</span> <span class="n">number_processes</span>

        <span class="k">if</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;compression&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="mi">8</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="NodeChainOperation.create"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">input_paths</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; A factory method that creates the processes which form an operation</span>
<span class="sd">        based on the  information given in the operation specification, *operation_spec*.</span>

<span class="sd">        In debug mode this is done in serial. In the other default mode,</span>
<span class="sd">        at the moment 4 processes are created in parallel and can be immediately</span>
<span class="sd">        executed. So generation of processes and execution are made in parallel.</span>
<span class="sd">        This kind of process creation is done independently from the backend.</span>

<span class="sd">        For huge parameter spaces this is necessary!</span>
<span class="sd">        Otherwise numerous processes are created and corresponding data is loaded</span>
<span class="sd">        but the concept of spreading the computation to different processors</span>
<span class="sd">        can not really be used, because process creation is blocking only</span>
<span class="sd">        one processor and memory space, but nothing more is done,</span>
<span class="sd">        till the processes are all created.</span>

<span class="sd">        .. todo:: Use :class:`~pySPACE.resources.dataset_defs.dummy.DummyDataset`</span>
<span class="sd">                  for empty data, when no input_path is given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node_chain&quot;</span><span class="p">)</span>

        <span class="c1"># Determine all parameter combinations that should be tested</span>
        <span class="n">parameter_settings</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_get_parameter_space</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">)</span>

        <span class="c1">## Use node_chain parameter if no templates are given ##</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;templates&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;node_chain&quot;</span><span class="p">):</span>
                <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">operation_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;node_chain&quot;</span><span class="p">)]</span>
<span class="c1">#                    extract_key_str(operation_spec[&quot;base_file&quot;],</span>
<span class="c1">#                                    keyword=&quot;node_chain&quot;)]</span>
<span class="c1">#                operation_spec.pop(&quot;node_chain&quot;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Specify parameter &#39;templates&#39; or &#39;node_chain&#39; in your operation spec!&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;node_chain&quot;</span><span class="p">):</span>
            <span class="n">operation_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;node_chain&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;node_chain parameter is ignored. Templates are used.&quot;</span><span class="p">)</span>
        <span class="c1"># load files in templates as dictionaries</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;template_files&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])):</span>
                <span class="n">rel_node_chain_file</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">abs_node_chain_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">spec_dir</span><span class="p">,</span> <span class="s2">&quot;node_chains&quot;</span><span class="p">,</span>
                    <span class="n">rel_node_chain_file</span><span class="p">])</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_node_chain_file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
                    <span class="n">node_chain</span> <span class="o">=</span> <span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="c1">#node_chain = yaml.load(read_file)</span>
                <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_chain</span>

        <span class="n">storage</span> <span class="o">=</span> <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No input datasets found in input_path </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">!&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;input_path&quot;</span><span class="p">],</span><span class="n">storage</span><span class="p">))</span>

        <span class="c1"># Get relative path</span>
        <span class="n">rel_input_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">storage</span><span class="p">):]</span>
                           <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span>  <span class="n">input_paths</span><span class="p">]</span>

        <span class="c1"># Determine approximate number of runs</span>
        <span class="k">if</span> <span class="s2">&quot;runs&quot;</span> <span class="ow">in</span> <span class="n">operation_spec</span><span class="p">:</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;runs&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dataset_dir</span> <span class="ow">in</span> <span class="n">rel_input_paths</span><span class="p">:</span>
                <span class="n">abs_collection_path</span> <span class="o">=</span> \
                        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> \
                            <span class="o">+</span> <span class="n">dataset_dir</span>
                <span class="n">collection_runs</span> <span class="o">=</span> \
                        <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">abs_collection_path</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collection_runs</span><span class="p">)</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>

        <span class="c1"># Determine splits</span>
        <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">rel_input_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">abs_collection_path</span> <span class="o">=</span> \
                <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">dataset_dir</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">abs_collection_path</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splits&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Determine how many processes will be created</span>
        <span class="n">number_processes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])</span> <span class="o">*</span> \
                           <span class="nb">len</span><span class="p">(</span><span class="n">parameter_settings</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_input_paths</span><span class="p">)</span> <span class="o">*</span> \
                           <span class="n">runs</span> <span class="o">*</span> <span class="n">splits</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c1"># To better debug creation of processes we don&#39;t limit the queue</span>
            <span class="c1"># and create all processes before executing them</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">processing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_createProcesses</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span>
                                 <span class="n">parameter_settings</span><span class="p">,</span> <span class="n">rel_input_paths</span><span class="p">)</span>
            <span class="c1"># create and return the operation object</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span>
                       <span class="n">number_processes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create all processes by calling a recursive helper method in</span>
            <span class="c1"># another thread so that already created processes can be executed in</span>
            <span class="c1"># parallel. Therefore a queue is used which size is maximized to</span>
            <span class="c1"># guarantee that not to much objects are created (because this costs</span>
            <span class="c1"># memory). However, the actual number of 4 is arbitrary and might</span>
            <span class="c1"># be changed according to the system at hand.</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">processing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">create_process</span> <span class="o">=</span> \
                    <span class="n">processing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">_createProcesses</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span>
                                             <span class="n">operation_spec</span><span class="p">,</span> <span class="n">parameter_settings</span><span class="p">,</span>
                                             <span class="n">rel_input_paths</span><span class="p">))</span>
            <span class="n">create_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c1"># create and return the operation object</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span>
                       <span class="n">number_processes</span><span class="p">,</span> <span class="n">create_process</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="NodeChainOperation._createProcesses"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation._createProcesses">[docs]</a>    <span class="k">def</span> <span class="nf">_createProcesses</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">result_directory</span><span class="p">,</span> <span class="n">operation_spec</span><span class="p">,</span>
                         <span class="n">parameter_settings</span><span class="p">,</span> <span class="n">input_collections</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">storage_format</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;storage_format&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;storage_format&quot;</span> \
                <span class="ow">in</span> <span class="n">operation_spec</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Determine whether the node_chain should be stored after data processing</span>
            <span class="n">store_node_chain</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;store_node_chain&quot;</span><span class="p">]</span> \
                             <span class="k">if</span> <span class="s2">&quot;store_node_chain&quot;</span> <span class="ow">in</span> <span class="n">operation_spec</span> <span class="k">else</span> <span class="kc">False</span>

            <span class="c1"># Determine whether certain parameters should not be remembered</span>
            <span class="n">hide_parameters</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="s2">&quot;hide_parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">operation_spec</span> \
                                    <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;hide_parameters&quot;</span><span class="p">])</span>
            <span class="n">hide_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;__INPUT_COLLECTION__&quot;</span><span class="p">)</span>
            <span class="n">hide_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;__INPUT_DATASET__&quot;</span><span class="p">)</span>
            <span class="n">hide_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;__RESULT_DIRECTORY__&quot;</span><span class="p">)</span>
            <span class="n">hide_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;__OUTPUT_BUNDLE__&quot;</span><span class="p">)</span>
            <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;hide_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hide_parameters</span>

            <span class="c1"># Create all combinations of collections, runs and splits</span>
            <span class="n">collection_run_split_combinations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">input_dataset_dir</span> <span class="ow">in</span> <span class="n">input_collections</span><span class="p">:</span>
                <span class="c1"># Determine number of runs to be conducted for this collection</span>
                <span class="n">abs_collection_path</span> <span class="o">=</span> \
                    <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> \
                        <span class="o">+</span> <span class="n">input_dataset_dir</span>
                <span class="n">collection_runs</span> <span class="o">=</span> \
                    <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">abs_collection_path</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># D.get(k[,d]) -&gt; D[k] if k in D, else d.</span>

                <span class="k">if</span> <span class="s2">&quot;runs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">operation_spec</span><span class="p">:</span>
                    <span class="n">requested_runs</span> <span class="o">=</span> <span class="n">collection_runs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">requested_runs</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;runs&quot;</span><span class="p">]</span>

                <span class="k">assert</span> <span class="n">collection_runs</span> <span class="o">==</span> <span class="n">requested_runs</span> \
                    <span class="ow">or</span> <span class="n">collection_runs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
                    <span class="s2">&quot;Requested </span><span class="si">%s</span><span class="s2"> runs but input collection </span><span class="si">%s</span><span class="s2"> provides &quot;</span>\
                    <span class="s2">&quot;data for </span><span class="si">%s</span><span class="s2"> runs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">requested_runs</span><span class="p">,</span> <span class="n">input_dataset_dir</span><span class="p">,</span>
                                           <span class="n">collection_runs</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">requested_runs</span><span class="p">,</span> <span class="n">collection_runs</span><span class="p">)):</span>
                    <span class="n">collection_splits</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span>
                        <span class="n">abs_collection_path</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splits&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">collection_splits</span><span class="p">):</span>
                        <span class="n">collection_run_split_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">input_dataset_dir</span><span class="p">,</span>
                                                                  <span class="n">run</span><span class="p">,</span> <span class="n">split</span><span class="p">))</span>

            <span class="c1"># Shuffle order of dataset-run-split combinations. This should help to</span>
            <span class="c1"># avoid that all processes work on the same data which can cause</span>
            <span class="c1"># problems due to locking etc.</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">collection_run_split_combinations</span><span class="p">)</span>

            <span class="c1"># For all templates</span>
            <span class="k">for</span> <span class="n">node_chain_spec</span> <span class="ow">in</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]:</span>
                <span class="c1"># For all possible parameter instantiations of this template</span>
                <span class="k">for</span> <span class="n">parameter_setting</span> <span class="ow">in</span> <span class="n">parameter_settings</span><span class="p">:</span>
                    <span class="c1"># For all input collections-run combinations</span>
                    <span class="k">for</span> <span class="n">input_dataset_dir</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> \
                            <span class="n">collection_run_split_combinations</span><span class="p">:</span>
                        <span class="c1"># We are going to change the parameter_setting and don&#39;t</span>
                        <span class="c1"># want to interfere with later runs so we work on a copy</span>
                        <span class="n">parameter_setting_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parameter_setting</span><span class="p">)</span>

                        <span class="c1"># Add input and output path to parameter</span>
                        <span class="c1"># setting</span>
                        <span class="n">parameter_setting_cp</span><span class="p">[</span><span class="s2">&quot;__INPUT_DATASET__&quot;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">input_dataset_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">parameter_setting_cp</span><span class="p">[</span><span class="s2">&quot;__RESULT_DIRECTORY__&quot;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">result_directory</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node_chain_spec</span><span class="p">)</span>
                            <span class="n">parameter_setting_cp</span><span class="p">[</span><span class="s2">&quot;__Template__&quot;</span><span class="p">]</span><span class="o">=</span>\
                                <span class="n">operation_spec</span><span class="p">[</span><span class="s2">&quot;template_files&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

                        <span class="c1"># Load the input meta data</span>
                        <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
                                                   <span class="n">input_dataset_dir</span><span class="p">])</span>
                        <span class="n">dataset_md</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">)</span>
                        <span class="c1"># Add the input parameter&#39;s meta data</span>
                        <span class="c1"># to the given parameter setting</span>
                        <span class="k">if</span> <span class="s2">&quot;parameter_setting&quot;</span> <span class="ow">in</span> <span class="n">dataset_md</span><span class="p">:</span>
                            <span class="n">dataset_md</span><span class="p">[</span><span class="s2">&quot;parameter_setting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="n">parameter_setting_cp</span><span class="p">)</span>
                            <span class="n">all_parameters</span> <span class="o">=</span> <span class="n">dataset_md</span><span class="p">[</span><span class="s2">&quot;parameter_setting&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">all_parameters</span> <span class="o">=</span> <span class="n">parameter_setting_cp</span>

                        <span class="k">def</span> <span class="nf">check_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                                <span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">check_constraint</span><span class="p">(</span>
                                <span class="n">constraint_def</span><span class="p">,</span> <span class="n">all_parameters</span><span class="p">)</span> <span class="k">for</span> <span class="n">constraint_def</span>
                                <span class="ow">in</span> <span class="n">operation_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_parameter_constraints&#39;</span><span class="p">,</span>
                                                      <span class="p">[])):</span>
                            <span class="k">continue</span>

                        <span class="c1"># Determine directory in which the result of this</span>
                        <span class="c1"># process should be written</span>
                        <span class="n">result_dataset_directory</span> <span class="o">=</span> \
                            <span class="n">NodeChainOperation</span><span class="o">.</span><span class="n">_get_result_dataset_dir</span><span class="p">(</span>
                                <span class="n">result_directory</span><span class="p">,</span>
                                <span class="n">input_dataset_dir</span><span class="p">,</span>
                                <span class="n">parameter_setting_cp</span><span class="p">,</span>
                                <span class="n">hide_parameters</span><span class="p">)</span>


                        <span class="c1"># Create the respective process and put it to the</span>
                        <span class="c1"># executing-queue of processes</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">NodeChainProcess</span><span class="p">(</span>
                            <span class="n">node_chain_spec</span><span class="o">=</span><span class="n">node_chain_spec</span><span class="p">,</span>
                            <span class="n">parameter_setting</span><span class="o">=</span><span class="n">parameter_setting_cp</span><span class="p">,</span>
                            <span class="n">rel_dataset_dir</span><span class="o">=</span><span class="n">input_dataset_dir</span><span class="p">,</span>
                            <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                            <span class="n">storage_format</span><span class="o">=</span><span class="n">storage_format</span><span class="p">,</span>
                            <span class="n">result_dataset_directory</span><span class="o">=</span><span class="n">result_dataset_directory</span><span class="p">,</span>
                            <span class="n">store_node_chain</span><span class="o">=</span><span class="n">store_node_chain</span><span class="p">,</span>
                            <span class="n">hide_parameters</span><span class="o">=</span><span class="n">hide_parameters</span><span class="p">)</span>

                        <span class="n">processes</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># give executing process the sign that creation is now finished</span>
            <span class="n">processes</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeChainOperation.consolidate"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation.consolidate">[docs]</a>    <span class="k">def</span> <span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Consolidates the results obtained by the single processes into a consistent structure</span>
<span class="sd">        of collections that are stored on the file system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Consolidate the results</span>
        <span class="n">directory_pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">,</span> <span class="s2">&quot;{*&quot;</span><span class="p">,])</span>
        <span class="n">dataset_pathes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">directory_pattern</span><span class="p">)</span>

        <span class="c1"># For all collections found</span>
        <span class="k">for</span> <span class="n">dataset_path</span> <span class="ow">in</span> <span class="n">dataset_pathes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load their meta_data</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>

                <span class="c1"># Determine author and date</span>
                <span class="n">author</span> <span class="o">=</span> <span class="n">get_author</span><span class="p">()</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>

                <span class="c1"># Update meta data and store it</span>
                <span class="n">meta_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">author</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">})</span>

                <span class="c1"># There can be either run dirs, persistency dirs, or both of them.</span>
                <span class="c1"># Check of whichever there are more. If both exist, their numbers</span>
                <span class="c1"># are supposed to be equal.</span>
                <span class="n">nr_run_dirs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;data_run*&quot;</span><span class="p">)))</span>
                <span class="n">nr_per_dirs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;persistency_run*&quot;</span><span class="p">)))</span>
                <span class="n">nr_runs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nr_run_dirs</span><span class="p">,</span> <span class="n">nr_per_dirs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nr_runs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;runs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr_runs</span>

                <span class="c1"># Store the metadata</span>
                <span class="n">BaseDataset</span><span class="o">.</span><span class="n">store_meta_data</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">)</span>

                <span class="c1"># Copy the input dataset specification file to the result</span>
                <span class="c1"># directory in order to make later analysis of</span>
                <span class="c1"># the results more easy</span>
                <span class="c1"># THA: Split the first &quot;/&quot; from the input collection name, because otherwise it will be treated</span>
                <span class="c1"># as an absolute path</span>
                <span class="n">input_collection_name</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;input_collection_name&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> \
                    <span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;input_collection_name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="k">else</span> <span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;input_collection_name&quot;</span><span class="p">]</span>
                <span class="n">input_meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span> <span class="n">input_collection_name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">input_meta</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">input_meta_path</span><span class="p">)</span>
                    <span class="n">BaseDataset</span><span class="o">.</span><span class="n">store_meta_data</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">input_meta</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;input_metadata.yaml&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Error copying the input_metadata.yaml: </span><span class="si">{error}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">),</span>
                              <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error updating the metadata: </span><span class="si">{error!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># If we don&#39;t create a feature vector or time series collection,</span>
        <span class="c1"># we evaluated our classification using a classification performance sink.</span>
        <span class="c1"># The resulting files should be merged to one csv tabular.</span>
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">,</span><span class="s2">&quot;results_*&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Do the consolidation the same way as for WekaClassificationOperation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Consolidating results ...&quot;</span><span class="p">)</span>
            <span class="c1"># We load and store the results once into a PerformanceResultSummary</span>
            <span class="c1"># This does the necessary consolidation...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Reading intermediate results...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_collection</span> <span class="o">=</span> <span class="n">PerformanceResultSummary</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Storing result collection&quot;</span><span class="p">)</span>
                <span class="n">result_collection</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
                <span class="n">PerformanceResultSummary</span><span class="o">.</span><span class="n">merge_traces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error merging the result collection: </span><span class="si">{error!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">:</span>
                <span class="c1"># Since we get one result summary,</span>
                <span class="c1"># we don&#39;t need the numerous folders.</span>
                <span class="c1"># So we zip them to make the whole folder more easy visible.</span>
                <span class="kn">import</span> <span class="nn">zipfile</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
                <span class="c1"># If there are to many or to large folders, problems may occur.</span>
                <span class="c1"># This case we want to log, try 64 bit mode,</span>
                <span class="c1"># and then skip the zipping.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pathlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">,</span><span class="s2">&quot;{*}&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
                        <span class="n">save_file</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="o">+</span><span class="s1">&#39;/result_folders.zip&#39;</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
                        <span class="c1"># we want to have the zipped file relative to the</span>
                        <span class="c1"># result directory</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                                <span class="n">rel_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
                                <span class="n">save_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="n">save_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rel_path</span><span class="p">,</span>
                                                                 <span class="n">data</span><span class="p">))</span>
                        <span class="n">save_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="c1"># To still have an easy access to the history of the</span>
                    <span class="c1"># processing, we keep one folder.</span>
                    <span class="n">pathlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Result files could not be compressed with 32&quot;</span><span class="o">+</span>
                              <span class="s2">&quot; bit mode, switching to 64 bit mode&quot;</span><span class="p">,</span>
                              <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
                    <span class="c1"># nearly total code copy, only difference with 64 bit mode</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">,</span><span class="s2">&quot;{*}&quot;</span><span class="p">))</span>
                        <span class="n">save_file</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="o">+</span><span class="s1">&#39;/result_folders.zip&#39;</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span>
                            <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># we want to have the zipped file relative to the</span>
                        <span class="c1"># result directory</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                                <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">result_directory</span><span class="p">)</span>
                                <span class="n">save_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="n">save_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rel_path</span><span class="p">,</span><span class="n">data</span><span class="p">))</span>
                        <span class="n">save_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="c1"># To still have an easy access to the history of the</span>
                        <span class="c1"># processing, we keep one folder.</span>
                        <span class="n">pathlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;64 bit mode also failed. Please check your files and your code or contact your local programmer!&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NodeChainOperation._get_result_dataset_dir"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainOperation._get_result_dataset_dir">[docs]</a>    <span class="k">def</span> <span class="nf">_get_result_dataset_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">input_dataset_dir</span><span class="p">,</span>
                                <span class="n">parameter_setting</span><span class="p">,</span> <span class="n">hide_parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines the name of the result directory</span>

<span class="sd">        Determines the name of the result directory based on the</span>
<span class="sd">        input_dataset_dir, the node_chain_name and the parameter setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the result_directory name</span>
        <span class="c1"># String between Key and value changed from &quot;:&quot; to &quot;#&quot;,</span>
        <span class="c1"># because ot problems in windows and with windows file servers</span>
        <span class="k">def</span> <span class="nf">_get_result_dir_name</span><span class="p">(</span><span class="n">parameter_setting</span><span class="p">,</span> <span class="n">hide_parameters</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; internal function to create result dir name in different ways&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">parameter_str</span> <span class="o">=</span> <span class="s2">&quot;}{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                  <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">#</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
                  <span class="n">parameter_setting</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hide_parameters</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span>
                <span class="n">parameter_str</span> <span class="o">=</span> <span class="s2">&quot;}{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                  <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">#</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
                  <span class="n">parameter_setting</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hide_parameters</span><span class="p">)</span>

            <span class="n">parameter_str</span> <span class="o">=</span> <span class="n">parameter_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">parameter_str</span> <span class="o">=</span> <span class="n">parameter_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">parameter_str</span> <span class="o">=</span> <span class="n">parameter_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">parameter_str</span> <span class="o">=</span> <span class="n">parameter_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">parameter_str</span> <span class="o">=</span> <span class="n">parameter_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">input_name</span>

            <span class="k">if</span> <span class="n">parameter_str</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">result_name</span> <span class="o">+=</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parameter_str</span><span class="p">)</span>

            <span class="c1"># Determine the path where this result will be stored</span>
            <span class="c1"># and create the directory if necessary</span>
            <span class="n">result_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
            <span class="n">result_dir</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">result_name</span>
            <span class="c1"># filename is to long</span>
            <span class="c1"># (longer than allowed including optional offsets for pyspace</span>
            <span class="c1">#  result csv naming conventions)</span>
            <span class="c1"># create a md5 hash of the result name and use that one</span>
            <span class="kn">import</span> <span class="nn">platform</span>
            <span class="n">CURRENTOS</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">CURRENTOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                <span class="c1"># the maximum length for a filename on Windows is 255</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span><span class="o">+</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">result_name</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;}&quot;</span>
                    <span class="n">result_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
                    <span class="n">result_dir</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">result_name</span>
                <span class="k">return</span> <span class="n">result_dir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">pathconf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s1">&#39;PC_NAME_MAX&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span><span class="o">+</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">result_name</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;}&quot;</span>
                    <span class="n">result_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
                    <span class="n">result_dir</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">result_name</span>
                <span class="k">return</span> <span class="n">result_dir</span>

        <span class="n">input_name</span> <span class="o">=</span> <span class="n">input_dataset_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">input_name</span> <span class="o">=</span> <span class="n">input_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># If the input is already the result of an operation</span>
        <span class="k">if</span> <span class="n">input_name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;}{&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">input_name_parts</span> <span class="o">=</span> <span class="n">input_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}{&quot;</span><span class="p">)</span>
            <span class="n">input_name</span> <span class="o">=</span> <span class="n">input_name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Load the input meta data</span>
        <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
                                   <span class="n">input_dataset_dir</span><span class="p">])</span>
        <span class="n">dataset_md</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">)</span>

        <span class="c1"># We are going to change the parameter_setting and don&#39;t want to</span>
        <span class="c1"># interfere with later runs so we work on a copy</span>
        <span class="n">parameter_setting</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parameter_setting</span><span class="p">)</span>

        <span class="c1"># Ignore pseudo parameter &quot;__PREPARE_OPERATION__&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;__PREPARE_OPERATION__&quot;</span> <span class="ow">in</span> <span class="n">parameter_setting</span><span class="p">:</span>
            <span class="n">parameter_setting</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__PREPARE_OPERATION__&quot;</span><span class="p">)</span>

        <span class="c1"># Add the input parameters meta data to the given parameter setting</span>
        <span class="k">if</span> <span class="s2">&quot;parameter_setting&quot;</span> <span class="ow">in</span> <span class="n">dataset_md</span><span class="p">:</span>
            <span class="n">parameter_setting</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset_md</span><span class="p">[</span><span class="s2">&quot;parameter_setting&quot;</span><span class="p">])</span>

        <span class="c1"># We have to remove &#39; characters from the parameter value since</span>
        <span class="c1"># Weka does ignore them</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameter_setting</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parameter_setting</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">result_dir</span> <span class="o">=</span> <span class="n">_get_result_dir_name</span><span class="p">(</span><span class="n">parameter_setting</span><span class="p">,</span> <span class="n">hide_parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">create_directory</span><span class="p">(</span><span class="n">result_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">36</span><span class="p">:</span>
                <span class="c1"># filename is too long</span>
                <span class="n">result_dir</span> <span class="o">=</span> <span class="n">_get_result_dir_name</span><span class="p">(</span><span class="n">parameter_setting</span><span class="p">,</span>
                                                  <span class="n">hide_parameters</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">)</span>
            <span class="n">create_directory</span><span class="p">(</span><span class="n">result_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_dir</span></div></div>


<div class="viewcode-block" id="NodeChainProcess"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainProcess">[docs]</a><span class="k">class</span> <span class="nc">NodeChainProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run a specific signal processing chain with specific parameters and set and store results</span>

<span class="sd">    This is an atomic task,which takes</span>
<span class="sd">    a dataset (EEG-data, time series data, feature vector data in different formats)</span>
<span class="sd">    as input and produces a certain</span>
<span class="sd">    output (e.g. ARFF, pickle files, performance tabular).</span>
<span class="sd">    The execution of</span>
<span class="sd">    this process consists of applying a  given NodeChain</span>
<span class="sd">    on an input for a certain configuration.</span>

<span class="sd">    **Parameters**</span>
<span class="sd">        :node_chain_spec:       String in YAML syntax of the node chain.</span>

<span class="sd">        :parameter_setting:     parameters chosen for this process</span>
<span class="sd">        :rel_dataset_dir:       location of input file relative to the pySPACE</span>
<span class="sd">                                *storage*, specified in the configuration file</span>
<span class="sd">        :run:                   When process is started repeatedly, to deal</span>
<span class="sd">                                with random components, we have to forward</span>
<span class="sd">                                the current run number to these components.</span>
<span class="sd">        :split:                 When there are different splits, forward the split</span>
<span class="sd">                                number.</span>
<span class="sd">        :storage_format:        Choice of format, the resulting data is saved.</span>
<span class="sd">                                This should always fit to the sink node</span>
<span class="sd">                                specified as the last node in the chain.</span>
<span class="sd">        :result_dataset_directory:   Folder where the result is saved at.</span>

<span class="sd">        :store_node_chain:    option to save as pickle file the total state of</span>
<span class="sd">                        the node chain after the processing;</span>
<span class="sd">                        separately for each split in cross validation if</span>
<span class="sd">                        existing</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NodeChainProcess.__init__"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainProcess.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_chain_spec</span><span class="p">,</span> <span class="n">parameter_setting</span><span class="p">,</span>
                 <span class="n">rel_dataset_dir</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">storage_format</span><span class="p">,</span>
                 <span class="n">result_dataset_directory</span><span class="p">,</span> <span class="n">store_node_chain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">hide_parameters</span><span class="o">=</span><span class="p">[]):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NodeChainProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span> <span class="o">=</span> <span class="n">node_chain_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span> <span class="o">=</span> <span class="n">parameter_setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_dataset_dir</span> <span class="o">=</span> <span class="n">rel_dataset_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_format</span> <span class="o">=</span> <span class="n">storage_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_dataset_directory</span> <span class="o">=</span> <span class="n">result_dataset_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persistency_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">result_dataset_directory</span><span class="p">,</span>
                                            <span class="s2">&quot;persistency_run</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">run</span><span class="p">])</span>
        <span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persistency_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_node_chain</span> <span class="o">=</span> <span class="n">store_node_chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_parameters</span> <span class="o">=</span> <span class="n">hide_parameters</span>

        <span class="c1"># reduce_log_level for process creation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">console_log_level</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">console_log_level</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="s2">&quot;console_log_level&quot;</span><span class="p">)</span> \
                <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
            <span class="n">console_log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_log_level</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">file_log_level</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span> <span class="s2">&quot;file_log_level&quot;</span><span class="p">)</span> \
                <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
            <span class="n">file_log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_log_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">console_log_level</span><span class="p">,</span><span class="n">file_log_level</span><span class="p">)</span>
        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">min_log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_log_level</span>
        <span class="c1"># Replace parameters in spec file</span>
<span class="c1">#        self.node_chain_spec = replace_parameters_and_convert(</span>
<span class="c1">#            self.node_chain_spec, self.parameter_setting)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span> <span class="o">=</span> <span class="n">replace_parameters2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span><span class="p">)</span>
        <span class="c1"># Create node chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span> <span class="o">=</span> <span class="n">NodeChainFactory</span><span class="o">.</span><span class="n">flow_from_yaml</span><span class="p">(</span>
            <span class="n">Flow_Class</span><span class="o">=</span><span class="n">BenchmarkNodeChain</span><span class="p">,</span> <span class="n">flow_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">current_split</span> <span class="o">=</span> <span class="n">split</span>
        <span class="c1"># Remove pseudo parameter &quot;__PREPARE_OPERATION__&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;__PREPARE_OPERATION__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__PREPARE_OPERATION__&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeChainProcess.__call__"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainProcess.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes this process on the respective modality &quot;&quot;&quot;</span>
        <span class="c1"># Restore configuration</span>
        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span>

        <span class="c1"># reduce log_level for processing a second time and</span>
        <span class="c1"># set communication possibility for nodes to backend</span>
        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">min_log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_log_level</span>
        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">logging_com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler_args</span>
        <span class="n">pySPACE</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">backend_com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_com</span>

        <span class="c1">############## Prepare benchmarking ##############</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NodeChainProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pre_benchmarking</span><span class="p">()</span>

        <span class="c1"># Load the data and check that it can be processed</span>
        <span class="c1"># Note: This can not be done in the objects constructor since in</span>
        <span class="c1"># that case the whole input would need to be pickled</span>
        <span class="c1"># when doing the remote call</span>
        <span class="n">abs_dataset_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">rel_dataset_dir</span><span class="p">])</span>

        <span class="n">input_collection</span> <span class="o">=</span> <span class="n">BaseDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">abs_dataset_dir</span><span class="p">)</span>

        <span class="c1"># We have to remember parameters used for generating this specific</span>
        <span class="c1"># input dataset</span>
        <span class="k">if</span> <span class="s1">&#39;parameter_setting&#39;</span> <span class="ow">in</span> <span class="n">input_collection</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># but not __INPUT_DATASET__ and __RESULT_DIRECTORY__</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_collection</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s1">&#39;parameter_setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__INPUT_DATASET__&quot;</span><span class="p">,</span> <span class="s2">&quot;__RESULT_DIRECTORY__&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">NodeChainProcess</span><span class="o">.</span><span class="n">_check_node_chain_dataset_consistency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="p">,</span>
                                                               <span class="n">input_collection</span><span class="p">)</span>

        <span class="c1">############## Do the actual benchmarking ##############</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Start benchmarking run </span><span class="si">%s</span><span class="s2"> of node_chain </span><span class="si">%s</span><span class="s2"> on dataset </span><span class="si">%s</span><span class="s2">&quot;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">rel_dataset_dir</span><span class="p">))</span>


        <span class="c1"># Do the actual benchmarking for this collection/node_chain combination</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_collection</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="o">.</span><span class="n">benchmark</span><span class="p">(</span>
                    <span class="n">input_collection</span><span class="o">=</span><span class="n">input_collection</span><span class="p">,</span>
                    <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                    <span class="n">persistency_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">persistency_dir</span><span class="p">,</span>
                    <span class="n">store_node_chain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_node_chain</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span>
            <span class="c1"># Send Exception to Logger</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Finished benchmarking run </span><span class="si">%s</span><span class="s2"> of node_chain </span><span class="si">%s</span><span class="s2"> on dataset </span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">rel_dataset_dir</span><span class="p">))</span>

        <span class="c1">############## Postprocessing ##############</span>

        <span class="c1"># Add input collection, node_chain file name, and run number</span>
        <span class="c1"># to the meta data</span>
        <span class="n">meta_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;node_chain_spec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_chain_spec</span><span class="p">,</span>
                     <span class="s2">&quot;parameter_setting&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setting</span><span class="p">,</span>
                     <span class="s2">&quot;input_collection_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_dataset_dir</span><span class="p">,</span>
                     <span class="s2">&quot;hide_parameters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_parameters</span><span class="p">}</span>
        <span class="n">result_collection</span><span class="o">.</span><span class="n">update_meta_data</span><span class="p">(</span><span class="n">meta_data</span><span class="p">)</span>

        <span class="c1"># Store the result collection to the hard disk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_format</span><span class="p">:</span>
            <span class="n">result_collection</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_dataset_directory</span><span class="p">,</span>
                                    <span class="n">s_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_collection</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_dataset_directory</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">result_collection</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_chain</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1">############## Clean up after benchmarking ##############</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NodeChainProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">post_benchmarking</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NodeChainProcess._check_node_chain_dataset_consistency"><a class="viewcode-back" href="../../../../api/generated/pySPACE.missions.operations.node_chain.html#pySPACE.missions.operations.node_chain.NodeChainProcess._check_node_chain_dataset_consistency">[docs]</a>    <span class="k">def</span> <span class="nf">_check_node_chain_dataset_consistency</span><span class="p">(</span><span class="n">node_chain</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks that the given node_chain can process the given dataset</span>

<span class="sd">        Therefore the first node in the node_chain has to be the corresponding</span>
<span class="sd">        source node to the dataset type</span>

<span class="sd">        .. todo:: Check dynamically! So that explicit imports aren&#39;t necessary!</span>
<span class="sd">                  For test node_chains use dummy dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySPACE.missions.nodes.source.time_series_source</span> \
            <span class="kn">import</span> <span class="nn">Stream2TimeSeriesSourceNode</span>
        <span class="kn">from</span> <span class="nn">pySPACE.missions.nodes.source.time_series_source</span> \
            <span class="kn">import</span> <span class="nn">TimeSeriesSourceNode</span>
        <span class="kn">from</span> <span class="nn">pySPACE.missions.nodes.source.time_series_source</span> \
            <span class="kn">import</span> <span class="nn">TimeSeries2TimeSeriesSourceNode</span>
        <span class="kn">from</span> <span class="nn">pySPACE.missions.nodes.source.feature_vector_source</span> \
            <span class="kn">import</span> <span class="nn">FeatureVectorSourceNode</span>
        <span class="kn">from</span> <span class="nn">pySPACE.missions.nodes.source.test_source_nodes</span> \
            <span class="kn">import</span> <span class="nn">DataGenerationTimeSeriesSourceNode</span>

        <span class="kn">from</span> <span class="nn">pySPACE.resources.dataset_defs.stream</span> \
            <span class="kn">import</span> <span class="nn">StreamDataset</span>
        <span class="kn">from</span> <span class="nn">pySPACE.resources.dataset_defs.time_series</span> \
            <span class="kn">import</span> <span class="nn">TimeSeriesDataset</span>
        <span class="kn">from</span> <span class="nn">pySPACE.resources.dataset_defs.feature_vector</span> \
            <span class="kn">import</span> <span class="nn">FeatureVectorDataset</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DataGenerationTimeSeriesSourceNode</span><span class="p">):</span>
            <span class="c1"># the test node does not care about the dataset type</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Stream2TimeSeriesSourceNode</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">StreamDataset</span><span class="p">)</span> <span class="ow">or</span>
                   <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">TimeSeriesDataset</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TimeSeries2TimeSeriesSourceNode</span><span class="p">)),</span> \
              <span class="s2">&quot;Node chain with input node of type </span><span class="si">%s</span><span class="s2"> cannot process dataset of type </span><span class="si">%s</span><span class="s2">&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TimeSeriesSourceNode</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">TimeSeriesDataset</span><span class="p">)),</span> \
                   <span class="s2">&quot;Node chain with input node of type </span><span class="si">%s</span><span class="s2"> cannot process dataset of type </span><span class="si">%s</span><span class="s2">&quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FeatureVectorSourceNode</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">FeatureVectorDataset</span><span class="p">)),</span> \
                <span class="s2">&quot;Node chain with input node of type </span><span class="si">%s</span><span class="s2"> cannot process dataset of type </span><span class="si">%s</span><span class="s2">&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span></div></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pySPACE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, pySPACE Developer Team.
      Last updated on Mar 14, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>